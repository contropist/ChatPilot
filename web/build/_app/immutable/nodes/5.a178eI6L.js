import{s as $e,l as Pe,v as Le,m as et,d as F,o as Oe,i as De,j as X,r as tt,k as Y,e as de,c as pe,a as ge,f as Z,g as x,p as ot,q as $,u as L}from"../chunks/scheduler.DiJq6vPF.js";import{S as st,i as nt,t as te,d as re,f as at,b as ee,c as Ie,a as Me,m as Te,e as Ce,g as lt}from"../chunks/index.BHjMAGPu.js";import{g as rt}from"../chunks/globals.D0QH3NT1.js";import{t as U}from"../chunks/Toaster.svelte_svelte_type_style_lang.BHLjDTk_.js";import{g as Ee}from"../chunks/entry.qYnHbvI-.js";import{p as it}from"../chunks/stores.BW9SmnG1.js";import{a as me,c as Ne,W as Je,L as ct,O as ut,t as qe,s as Ge,m as ft,d as dt,e as pt,b as gt}from"../chunks/index.EObCQwOH.js";import{v as Ve,s as We,c as je,a as mt}from"../chunks/index.CSs7Pbog.js";import{g as ht,a as _t,c as Fe}from"../chunks/index.CZYlxN09.js";import{c as wt,g as he,u as _e,a as yt,b as ve,d as bt,e as St,f as kt}from"../chunks/index.BMQETGiF.js";import{g as It}from"../chunks/index.BkffOsC6.js";import{N as Mt,M as Tt,a as Ct,b as Et}from"../chunks/Navbar.BPlFveRq.js";const{document:Re}=rt;function Ye(o){var be;let S,t,s,d,u,f,_,oe,z,se,T,w,C,R,k,P,I,M,J,K,q,O,r;t=new Mt({props:{title:o[9],shareEnabled:o[12].length>0,initNewChat:o[26],tags:o[8],addTag:o[22],deleteTag:o[23]}});function a(n){o[27](n)}let we={};o[0]!==void 0&&(we.selectedModels=o[0]),_=new Tt({props:we}),Y.push(()=>ee(_,"selectedModels",a));function V(n){o[28](n)}function Ae(n){o[29](n)}function ie(n){o[30](n)}let Q={chatId:o[14],selectedModels:o[0],selectedModelfiles:o[7],processing:Pt,bottomPadding:o[11].length>0,sendPrompt:o[18],continueGeneration:o[20],regenerateResponse:o[21]};o[1]!==void 0&&(Q.history=o[1]),o[12]!==void 0&&(Q.messages=o[12]),o[3]!==void 0&&(Q.autoScroll=o[3]),w=new Ct({props:Q}),Y.push(()=>ee(w,"history",V)),Y.push(()=>ee(w,"messages",Ae)),Y.push(()=>ee(w,"autoScroll",ie));function ye(n){o[33](n)}function Be(n){o[34](n)}function Ue(n){o[35](n)}let ne={suggestionPrompts:((be=o[6])==null?void 0:be.suggestionPrompts)??o[16].default_prompt_suggestions,messages:o[12],submitPrompt:o[17],stopResponse:o[19]};return o[11]!==void 0&&(ne.files=o[11]),o[10]!==void 0&&(ne.prompt=o[10]),o[3]!==void 0&&(ne.autoScroll=o[3]),I=new Et({props:ne}),Y.push(()=>ee(I,"files",ye)),Y.push(()=>ee(I,"prompt",Be)),Y.push(()=>ee(I,"autoScroll",Ue)),{c(){S=de("div"),Ie(t.$$.fragment),s=Pe(),d=de("div"),u=de("div"),f=de("div"),Ie(_.$$.fragment),se=Pe(),T=de("div"),Ie(w.$$.fragment),P=Pe(),Ie(I.$$.fragment),this.h()},l(n){S=pe(n,"DIV",{class:!0});var g=ge(S);Me(t.$$.fragment,g),s=Oe(g),d=pe(g,"DIV",{class:!0});var A=ge(d);u=pe(A,"DIV",{class:!0,id:!0});var W=ge(u);f=pe(W,"DIV",{class:!0});var E=ge(f);Me(_.$$.fragment,E),E.forEach(F),se=Oe(W),T=pe(W,"DIV",{class:!0});var D=ge(T);Me(w.$$.fragment,D),D.forEach(F),W.forEach(F),P=Oe(A),Me(I.$$.fragment,A),A.forEach(F),g.forEach(F),this.h()},h(){var n;Z(f,"class",z=(((n=o[13])==null?void 0:n.fullScreenMode)??null?"max-w-full":"max-w-2xl md:px-0")+" mx-auto w-full px-4"),Z(T,"class","h-full w-full flex flex-col py-8"),Z(u,"class","pb-2.5 flex flex-col justify-between w-full flex-auto overflow-auto h-0"),Z(u,"id","messages-container"),Z(d,"class","flex flex-col flex-auto"),Z(S,"class","min-h-screen max-h-screen w-full flex flex-col")},m(n,g){De(n,S,g),Te(t,S,null),x(S,s),x(S,d),x(d,u),x(u,f),Te(_,f,null),x(u,se),x(u,T),Te(w,T,null),o[31](u),x(d,P),Te(I,d,null),q=!0,O||(r=ot(u,"scroll",o[32]),O=!0)},p(n,g){var Se,ke;const A={};g[0]&512&&(A.title=n[9]),g[0]&4096&&(A.shareEnabled=n[12].length>0),g[0]&32&&(A.initNewChat=n[26]),g[0]&256&&(A.tags=n[8]),t.$set(A);const W={};!oe&&g[0]&1&&(oe=!0,W.selectedModels=n[0],$(()=>oe=!1)),_.$set(W),(!q||g[0]&8192&&z!==(z=(((Se=n[13])==null?void 0:Se.fullScreenMode)??null?"max-w-full":"max-w-2xl md:px-0")+" mx-auto w-full px-4"))&&Z(f,"class",z);const E={};g[0]&16384&&(E.chatId=n[14]),g[0]&1&&(E.selectedModels=n[0]),g[0]&128&&(E.selectedModelfiles=n[7]),g[0]&2048&&(E.bottomPadding=n[11].length>0),!C&&g[0]&2&&(C=!0,E.history=n[1],$(()=>C=!1)),!R&&g[0]&4096&&(R=!0,E.messages=n[12],$(()=>R=!1)),!k&&g[0]&8&&(k=!0,E.autoScroll=n[3],$(()=>k=!1)),w.$set(E);const D={};g[0]&65600&&(D.suggestionPrompts=((ke=n[6])==null?void 0:ke.suggestionPrompts)??n[16].default_prompt_suggestions),g[0]&4096&&(D.messages=n[12]),!M&&g[0]&2048&&(M=!0,D.files=n[11],$(()=>M=!1)),!J&&g[0]&1024&&(J=!0,D.prompt=n[10],$(()=>J=!1)),!K&&g[0]&8&&(K=!0,D.autoScroll=n[3],$(()=>K=!1)),I.$set(D)},i(n){q||(te(t.$$.fragment,n),te(_.$$.fragment,n),te(w.$$.fragment,n),te(I.$$.fragment,n),q=!0)},o(n){re(t.$$.fragment,n),re(_.$$.fragment,n),re(w.$$.fragment,n),re(I.$$.fragment,n),q=!1},d(n){n&&F(S),Ce(t),Ce(_),Ce(w),o[31](null),Ce(I),O=!1,r()}}}function Nt(o){let S,t,s,d;Re.title=S=`
		`+(o[9]?`${o[9].length>30?`${o[9].slice(0,30)}...`:o[9]} | ${o[15]}`:`${o[15]}`)+`
	`;let u=o[2]&&Ye(o);return{c(){t=Pe(),u&&u.c(),s=Le()},l(f){et("svelte-1123lr8",Re.head).forEach(F),t=Oe(f),u&&u.l(f),s=Le()},m(f,_){De(f,t,_),u&&u.m(f,_),De(f,s,_),d=!0},p(f,_){(!d||_[0]&33280)&&S!==(S=`
		`+(f[9]?`${f[9].length>30?`${f[9].slice(0,30)}...`:f[9]} | ${f[15]}`:`${f[15]}`)+`
	`)&&(Re.title=S),f[2]?u?(u.p(f,_),_[0]&4&&te(u,1)):(u=Ye(f),u.c(),te(u,1),u.m(s.parentNode,s)):u&&(lt(),re(u,1,1,()=>{u=null}),at())},i(f){d||(te(u),d=!0)},o(f){re(u),d=!1},d(f){f&&(F(t),F(s)),u&&u.d(f)}}}let Pt="";function Ot(o,S,t){let s,d,u,f,_,oe,z;X(o,Ge,e=>t(13,s=e)),X(o,Ne,e=>t(14,d=e)),X(o,ft,e=>t(38,u=e)),X(o,it,e=>t(24,f=e)),X(o,dt,e=>t(25,_=e)),X(o,pt,e=>t(15,oe=e)),X(o,gt,e=>t(16,z=e));let se=!1,T=!1,w=!0,C,R=null,k=[""],P=null,I={},M=null,J=[],K="",q="",O=[],r=[],a={messages:{},currentId:null};const we=async()=>{if(await Ne.set(f.params.id),M=await kt(localStorage.token,d).catch(async e=>(await Ee("/"),null)),M){t(8,J=await g());const e=M.chat;if(e){console.log(e),t(0,k=((e==null?void 0:e.models)??void 0)!==void 0?e.models:[e.models??""]),t(1,a=((e==null?void 0:e.history)??void 0)!==void 0?e.history:mt(e.messages)),t(9,K=e.title);let c=JSON.parse(localStorage.getItem("settings")??"{}");return await Ge.set({...c,system:e.system??c.system,options:e.options??c.options}),t(3,w=!0),await L(),r.length>0&&t(1,a.messages[r.at(-1).id].done=!0,a),await L(),!0}else return null}},V=()=>{t(4,C.scrollTop=C.scrollHeight,C)},Ae=async(e,c=null)=>{if(console.log("submitPrompt",d),k.includes(""))U.error("Model not selected");else if(r.length!=0&&r.at(-1).done!=!0)console.log("wait");else if(O.length>0&&O.filter(h=>h.upload_status===!1).length>0)U.error("Oops! Hold tight! Your files are still in the processing oven. We're cooking them up to perfection. Please be patient and we'll let you know once they're ready.");else{document.getElementById("chat-textarea").style.height="";let h=Ve(),y={id:h,parentId:r.length!==0?r.at(-1).id:null,childrenIds:[],role:"user",user:c??void 0,content:e,files:O.length>0?O:void 0,timestamp:Math.floor(Date.now()/1e3)};t(1,a.messages[h]=y,a),t(1,a.currentId=h,a),r.length!==0&&a.messages[r.at(-1).id].childrenIds.push(h),await L(),r.length==1&&(s.saveChatHistory??!0?(M=await wt(localStorage.token,{id:d,title:"New Chat",models:k,system:s.system??void 0,options:{...s.options??{}},messages:r,history:a,timestamp:Date.now()}),await me.set(await he(localStorage.token)),await Ne.set(M.id)):await Ne.set("local"),await L()),t(10,q=""),t(11,O=[]),await ie(e,h)}},ie=async(e,c)=>{const h=JSON.parse(JSON.stringify(d));await Promise.all(k.map(async y=>{const l=u.filter(b=>b.id===y).at(0);if(l){let b=Ve(),B={parentId:c,id:b,childrenIds:[],role:"assistant",content:"",model:l.id,timestamp:Math.floor(Date.now()/1e3)};t(1,a.messages[b]=B,a),t(1,a.currentId=b,a),c!==null&&t(1,a.messages[c].childrenIds=[...a.messages[c].childrenIds,b],a),l!=null&&l.external?await ye(l,e,b,h):l&&await Q(l,e,b,h)}else U.error(`Model ${y} not found`)})),await me.set(await he(localStorage.token))},Q=async(e,c,h,y)=>{var fe;e=e.id;const l=a.messages[h];await L(),V();const b=[s.system?{role:"system",content:s.system}:void 0,...r].filter(p=>p).map((p,N,ae)=>{var m;const H={role:p.role,content:ae.length-2!==N?p.content:(p==null?void 0:p.raContent)??p.content},i=(m=p.files)==null?void 0:m.filter(G=>G.type==="image").map(G=>G.url.slice(G.url.indexOf(",")+1));return i&&i.length>0&&(H.images=i),H});let B=-1;b.forEach((p,N)=>{p.images&&(B=N)}),b.forEach((p,N)=>{N!==B&&delete p.images});const ce=r.filter(p=>(p==null?void 0:p.files)??null).map(p=>p.files.filter(N=>N.type==="doc"||N.type==="collection")).flat(1),[v,ue]=await ht(localStorage.token,{model:e,messages:b,options:{...s.options??{}},format:s.requestFormat??void 0,keep_alive:s.keepAlive??void 0,docs:ce.length>0?ce:void 0});if(v&&v.ok){console.log("controller",ue);const p=v.body.pipeThrough(new TextDecoderStream).pipeThrough(We(`
`)).getReader();for(;;){const{value:N,done:ae}=await p.read();if(ae||T||y!==d){l.done=!0,t(12,r),t(1,a),T&&(ue.abort("User: Stop Response"),await Fe(localStorage.token,R)),t(5,R=null);break}try{let H=N.split(`
`);for(const i of H)if(i!==""){let m=JSON.parse(i);if("detail"in m)throw m;if("id"in m)t(5,R=m.id);else if(m.done==!1){if(l.content==""&&m.message.content==`
`)continue;l.content+=m.message.content,t(12,r),t(1,a)}else{if(l.done=!0,l.content==""&&(l.error=!0,l.content="Oops! No text generated from Ollama, Please try again."),l.context=m.context??null,l.info={total_duration:m.total_duration,load_duration:m.load_duration,sample_count:m.sample_count,sample_duration:m.sample_duration,prompt_eval_count:m.prompt_eval_count,prompt_eval_duration:m.prompt_eval_duration,eval_count:m.eval_count,eval_duration:m.eval_duration},t(12,r),t(1,a),s.notificationEnabled&&!document.hasFocus()){const G=new Notification(P?`${P.title.charAt(0).toUpperCase()+P.title.slice(1)}`:`${e}`,{body:l.content,icon:(P==null?void 0:P.imageUrl)??`${Je}/static/favicon.png`})}s.responseAutoCopy&&je(l.content),s.responseAutoPlayback&&(await L(),(fe=document.getElementById(`speak-button-${l.id}`))==null||fe.click())}}}catch(H){console.log(H),"detail"in H&&U.error(H.detail);break}V()}d==y&&(s.saveChatHistory??!0)&&(M=await _e(localStorage.token,y,{messages:r,history:a}),await me.set(await he(localStorage.token)))}else{if(v!==null){const p=await v.json();console.log(p),"detail"in p?(U.error(p.detail),l.content=p.detail):(U.error(p.error),l.content=p.error)}else U.error("Uh-oh! There was an issue connecting to Ollama."),l.content="Uh-oh! There was an issue connecting to Ollama.";l.error=!0,l.content="Uh-oh! There was an issue connecting to Ollama.",l.done=!0,t(12,r),t(1,a)}T=!1,await L(),V(),r.length==2&&r.at(1).content!==""&&(window.history.replaceState(a.state,"",`/c/${y}`),await be(y,c))},ye=async(e,c,h,y)=>{var ce,v,ue,fe,p,N,ae,H;const l=a.messages[h];V();const b=r.filter(i=>(i==null?void 0:i.files)??null).map(i=>i.files.filter(m=>m.type==="doc"||m.type==="collection")).flat(1);console.log(b);const B=await It(localStorage.token,{model:e.id,stream:!0,messages:[s.system?{role:"system",content:s.system}:void 0,...r].filter(i=>i).map((i,m,G)=>{var le;return{role:i.role,...((le=i.files)==null?void 0:le.filter(j=>j.type==="image").length)>0?{content:[{type:"text",text:G.length-1!==m?i.content:(i==null?void 0:i.raContent)??i.content},...i.files.filter(j=>j.type==="image").map(j=>({type:"image_url",image_url:{url:j.url}}))]}:{content:G.length-1!==m?i.content:(i==null?void 0:i.raContent)??i.content}}}),seed:((ce=s==null?void 0:s.options)==null?void 0:ce.seed)??void 0,stop:((v=s==null?void 0:s.options)==null?void 0:v.stop)??void 0,temperature:((ue=s==null?void 0:s.options)==null?void 0:ue.temperature)??void 0,top_p:((fe=s==null?void 0:s.options)==null?void 0:fe.top_p)??void 0,num_ctx:((p=s==null?void 0:s.options)==null?void 0:p.num_ctx)??void 0,frequency_penalty:((N=s==null?void 0:s.options)==null?void 0:N.repeat_penalty)??void 0,max_tokens:((ae=s==null?void 0:s.options)==null?void 0:ae.num_predict)??void 0,docs:b.length>0?b:void 0},e.source==="litellm"?`${ct}/v1`:`${ut}`);if(B&&B.ok){const i=B.body.pipeThrough(new TextDecoderStream).pipeThrough(We(`
`)).getReader();for(;;){const{value:m,done:G}=await i.read();if(G||T||y!==d){l.done=!0,t(12,r),t(1,a);break}try{let le=m.split(`
`);for(const j of le)if(j!=="")if(j==="data: [DONE]")l.done=!0,t(12,r),t(1,a);else{let He=JSON.parse(j.replace(/^data: /,""));if(l.content==""&&He.choices[0].delta.content==`
`)continue;l.content+=He.choices[0].delta.content??"",t(12,r),t(1,a)}}catch(le){console.log(le)}s.notificationEnabled&&!document.hasFocus()&&new Notification(`OpenAI ${e}`,{body:l.content,icon:`${Je}/static/favicon.png`}),s.responseAutoCopy&&je(l.content),s.responseAutoPlayback&&(await L(),(H=document.getElementById(`speak-button-${l.id}`))==null||H.click()),V()}d==y&&(s.saveChatHistory??!0)&&(M=await _e(localStorage.token,y,{messages:r,history:a}),await me.set(await he(localStorage.token)))}else{if(B!==null){const i=await B.json();console.log(i),"detail"in i?(U.error(i.detail),l.content=i.detail):"message"in i.error?(U.error(i.error.message),l.content=i.error.message):(U.error(i.error),l.content=i.error)}else U.error(`Uh-oh! There was an issue connecting to ${e}.`),l.content=`Uh-oh! There was an issue connecting to ${e}.`;l.error=!0,l.content=`Uh-oh! There was an issue connecting to ${e}.`,l.done=!0,t(12,r),t(1,a)}T=!1,await L(),V(),r.length==2&&(window.history.replaceState(a.state,"",`/c/${y}`),await n(y,c))},Be=()=>{T=!0,console.log("stopResponse")},Ue=async()=>{console.log("continueGeneration");const e=JSON.parse(JSON.stringify(d));if(r.length!=0&&r.at(-1).done==!0){const c=a.messages[a.currentId];c.done=!1,await L();const h=u.filter(y=>y.id===c.model).at(0);h&&(h!=null&&h.external?await ye(h,a.messages[c.parentId].content,c.id,e):await Q(h,a.messages[c.parentId].content,c.id,e))}else U.error(`Model ${modelId} not found`)},ne=async()=>{if(console.log("regenerateResponse"),r.length!=0&&r.at(-1).done==!0){r.splice(r.length-1,1),t(12,r),t(1,a);let e=r.at(-1),c=e.content;await ie(c,e.id)}},be=async(e,c)=>{if(s.titleAutoGenerate??!0){const h=await _t(localStorage.token,(s==null?void 0:s.titleGenerationPrompt)??"Create a concise, 3-5 word phrase as a header for the following query, strictly adhering to the 3-5 word limit and avoiding the use of the word 'title': {{prompt}}",(s==null?void 0:s.titleAutoGenerateModel)??k[0],c);h&&await n(e,h)}else await n(e,`${c}`)},n=async(e,c)=>{e===d&&t(9,K=c),M=await _e(localStorage.token,e,{title:c}),await me.set(await he(localStorage.token))},g=async()=>await St(localStorage.token,d).catch(async e=>[]),A=async e=>{await yt(localStorage.token,d,e),t(8,J=await g()),M=await _e(localStorage.token,d,{tags:J}),qe.set(await ve(localStorage.token))},W=async e=>{await bt(localStorage.token,d,e),t(8,J=await g()),M=await _e(localStorage.token,d,{tags:J}),qe.set(await ve(localStorage.token))};tt(async()=>{(s.saveChatHistory??!0)||await Ee("/")});const E=async()=>{R!==null&&(await Fe(localStorage.token,R),t(5,R=null)),Ee("/")};function D(e){k=e,t(0,k)}function Se(e){a=e,t(1,a)}function ke(e){r=e,t(12,r),t(1,a)}function ze(e){w=e,t(3,w)}function Ke(e){Y[e?"unshift":"push"](()=>{C=e,t(4,C)})}const Qe=e=>{t(3,w=C.scrollHeight-C.scrollTop<=C.clientHeight+50)};function Xe(e){O=e,t(11,O)}function Ze(e){q=e,t(10,q)}function xe(e){w=e,t(3,w)}return o.$$.update=()=>{if(o.$$.dirty[0]&33554433&&t(6,P=k.length===1&&_.filter(e=>e.tagName===k[0]).length>0?_.filter(e=>e.tagName===k[0])[0]:null),o.$$.dirty[0]&33554433&&t(7,I=k.reduce((e,c,h,y)=>{var b;const l=((b=_.filter(B=>B.tagName===c))==null?void 0:b.at(0))??void 0;return{...e,...l&&{[c]:l}}},{})),o.$$.dirty[0]&2)if(a.currentId!==null){let e=[],c=a.messages[a.currentId];for(;c!==null;)e.unshift({...c}),c=c.parentId!==null?a.messages[c.parentId]:null;t(12,r=e)}else t(12,r=[]);o.$$.dirty[0]&16777216&&f.params.id&&(async()=>{if(await we()){await L(),t(2,se=!0),window.setTimeout(()=>V(),0);const e=document.getElementById("chat-textarea");e==null||e.focus()}else await Ee("/")})()},[k,a,se,w,C,R,P,I,J,K,q,O,r,s,d,oe,z,Ae,ie,Be,Ue,ne,A,W,f,_,E,D,Se,ke,ze,Ke,Qe,Xe,Ze,xe]}class jt extends st{constructor(S){super(),nt(this,S,Ot,Nt,$e,{},null,[-1,-1])}}export{jt as component};
