import{s as Ke,k as z,l as Me,e as fe,m as Qe,d as v,o as Ie,c as de,a as pe,f as X,i as Le,g as Z,p as Xe,q as x,j as $,r as Ze,u as Y}from"../chunks/scheduler.DiJq6vPF.js";import{S as xe,i as $e,b as ee,c as Te,a as Ce,m as Ee,t as Pe,d as Ne,e as Ae}from"../chunks/index.BHjMAGPu.js";import{g as et}from"../chunks/globals.D0QH3NT1.js";import{t as O}from"../chunks/Toaster.svelte_svelte_type_style_lang.BHLjDTk_.js";import"../chunks/entry.qYnHbvI-.js";import{p as tt}from"../chunks/stores.BW9SmnG1.js";import{c as Oe,s as Ge,a as ge,W as Je,L as ot,O as st,t as qe,m as nt,b as at,d as lt,e as rt}from"../chunks/index.EObCQwOH.js";import{v as Ve,s as We,c as je}from"../chunks/index.CSs7Pbog.js";import{g as it,a as ct,c as Fe}from"../chunks/index.CZYlxN09.js";import{c as ut,g as me,u as he,a as ft,b as ve,d as dt,e as pt}from"../chunks/index.BMQETGiF.js";import{g as gt}from"../chunks/index.BkffOsC6.js";import{N as mt,M as ht,a as _t,b as wt}from"../chunks/Navbar.BPlFveRq.js";const{document:De}=et;function yt(n){var be;let K,o,t,g,G,w,S,M,E,H,y,I,T,u,P,te,B,J,b,j,N,r,a,oe,q;De.title=K=`
		`+(n[7]?`${n[7].length>30?`${n[7].slice(0,30)}...`:n[7]} | ${n[14]}`:`${n[14]}`)+`
	`,g=new mt({props:{title:n[7],shareEnabled:n[10].length>0,initNewChat:n[15],tags:n[6],addTag:n[21],deleteTag:n[22]}});function Be(s){n[24](s)}let se={};n[0]!==void 0&&(se.selectedModels=n[0]),E=new ht({props:se}),z.push(()=>ee(E,"selectedModels",Be));function _e(s){n[25](s)}function we(s){n[26](s)}function Ue(s){n[27](s)}let ne={chatId:n[12],selectedModels:n[0],selectedModelfiles:n[5],processing:St,bottomPadding:n[9].length>0,sendPrompt:n[17],continueGeneration:n[20],regenerateResponse:n[19]};n[1]!==void 0&&(ne.history=n[1]),n[10]!==void 0&&(ne.messages=n[10]),n[2]!==void 0&&(ne.autoScroll=n[2]),u=new _t({props:ne}),z.push(()=>ee(u,"history",_e)),z.push(()=>ee(u,"messages",we)),z.push(()=>ee(u,"autoScroll",Ue));function Re(s){n[30](s)}function ye(s){n[31](s)}function Se(s){n[32](s)}let ae={suggestionPrompts:((be=n[4])==null?void 0:be.suggestionPrompts)??n[13].default_prompt_suggestions,messages:n[10],submitPrompt:n[16],stopResponse:n[18]};return n[9]!==void 0&&(ae.files=n[9]),n[8]!==void 0&&(ae.prompt=n[8]),n[2]!==void 0&&(ae.autoScroll=n[2]),b=new wt({props:ae}),z.push(()=>ee(b,"files",Re)),z.push(()=>ee(b,"prompt",ye)),z.push(()=>ee(b,"autoScroll",Se)),{c(){o=Me(),t=fe("div"),Te(g.$$.fragment),G=Me(),w=fe("div"),S=fe("div"),M=fe("div"),Te(E.$$.fragment),I=Me(),T=fe("div"),Te(u.$$.fragment),J=Me(),Te(b.$$.fragment),this.h()},l(s){Qe("svelte-1123lr8",De.head).forEach(v),o=Ie(s),t=de(s,"DIV",{class:!0});var U=pe(t);Ce(g.$$.fragment,U),G=Ie(U),w=de(U,"DIV",{class:!0});var V=pe(w);S=de(V,"DIV",{class:!0,id:!0});var k=pe(S);M=de(k,"DIV",{class:!0});var R=pe(M);Ce(E.$$.fragment,R),R.forEach(v),I=Ie(k),T=de(k,"DIV",{class:!0});var Q=pe(T);Ce(u.$$.fragment,Q),Q.forEach(v),k.forEach(v),J=Ie(V),Ce(b.$$.fragment,V),V.forEach(v),U.forEach(v),this.h()},h(){var s;X(M,"class",y=(((s=n[11])==null?void 0:s.fullScreenMode)??null?"max-w-full":"max-w-2xl md:px-0")+" mx-auto w-full px-4"),X(T,"class","h-full w-full flex flex-col py-8"),X(S,"class","pb-2.5 flex flex-col justify-between w-full flex-auto overflow-auto h-0"),X(S,"id","messages-container"),X(w,"class","flex flex-col flex-auto"),X(t,"class","h-screen max-h-[100dvh] w-full flex flex-col")},m(s,h){Le(s,o,h),Le(s,t,h),Ee(g,t,null),Z(t,G),Z(t,w),Z(w,S),Z(S,M),Ee(E,M,null),Z(S,I),Z(S,T),Ee(u,T,null),n[28](S),Z(w,J),Ee(b,w,null),a=!0,oe||(q=Xe(S,"scroll",n[29]),oe=!0)},p(s,h){var Q,ke;(!a||h[0]&16512)&&K!==(K=`
		`+(s[7]?`${s[7].length>30?`${s[7].slice(0,30)}...`:s[7]} | ${s[14]}`:`${s[14]}`)+`
	`)&&(De.title=K);const U={};h[0]&128&&(U.title=s[7]),h[0]&1024&&(U.shareEnabled=s[10].length>0),h[0]&64&&(U.tags=s[6]),g.$set(U);const V={};!H&&h[0]&1&&(H=!0,V.selectedModels=s[0],x(()=>H=!1)),E.$set(V),(!a||h[0]&2048&&y!==(y=(((Q=s[11])==null?void 0:Q.fullScreenMode)??null?"max-w-full":"max-w-2xl md:px-0")+" mx-auto w-full px-4"))&&X(M,"class",y);const k={};h[0]&4096&&(k.chatId=s[12]),h[0]&1&&(k.selectedModels=s[0]),h[0]&32&&(k.selectedModelfiles=s[5]),h[0]&512&&(k.bottomPadding=s[9].length>0),!P&&h[0]&2&&(P=!0,k.history=s[1],x(()=>P=!1)),!te&&h[0]&1024&&(te=!0,k.messages=s[10],x(()=>te=!1)),!B&&h[0]&4&&(B=!0,k.autoScroll=s[2],x(()=>B=!1)),u.$set(k);const R={};h[0]&8208&&(R.suggestionPrompts=((ke=s[4])==null?void 0:ke.suggestionPrompts)??s[13].default_prompt_suggestions),h[0]&1024&&(R.messages=s[10]),!j&&h[0]&512&&(j=!0,R.files=s[9],x(()=>j=!1)),!N&&h[0]&256&&(N=!0,R.prompt=s[8],x(()=>N=!1)),!r&&h[0]&4&&(r=!0,R.autoScroll=s[2],x(()=>r=!1)),b.$set(R)},i(s){a||(Pe(g.$$.fragment,s),Pe(E.$$.fragment,s),Pe(u.$$.fragment,s),Pe(b.$$.fragment,s),a=!0)},o(s){Ne(g.$$.fragment,s),Ne(E.$$.fragment,s),Ne(u.$$.fragment,s),Ne(b.$$.fragment,s),a=!1},d(s){s&&(v(o),v(t)),Ae(g),Ae(E),Ae(u),n[28](null),Ae(b),oe=!1,q()}}}let St="";function bt(n,K,o){let t,g,G,w,S,M,E;$(n,Ge,e=>o(11,t=e)),$(n,Oe,e=>o(12,g=e)),$(n,nt,e=>o(36,G=e)),$(n,at,e=>o(13,w=e)),$(n,tt,e=>o(37,S=e)),$(n,lt,e=>o(23,M=e)),$(n,rt,e=>o(14,E=e));let H=!1,y=!0,I,T=null,u=[""],P=null,te={},B=null,J=[],b="",j="",N=[],r=[],a={messages:{},currentId:null};Ze(async()=>{await oe()});const oe=async()=>{var f;T!==null&&(await Fe(localStorage.token,T),T=null),window.history.replaceState(a.state,"","/"),await Oe.set(""),o(2,y=!0),o(7,b=""),o(10,r=[]),o(1,a={messages:{},currentId:null}),S.url.searchParams.get("models")?o(0,u=(f=S.url.searchParams.get("models"))==null?void 0:f.split(",")):t!=null&&t.models?o(0,u=t==null?void 0:t.models):w!=null&&w.default_models?o(0,u=w==null?void 0:w.default_models.split(",")):o(0,u=[""]),o(0,u=u.map(m=>G.map(l=>l.id).includes(m)?m:""));let e=JSON.parse(localStorage.getItem("settings")??"{}");Ge.set({...e});const c=document.getElementById("chat-textarea");setTimeout(()=>c==null?void 0:c.focus(),0)},q=()=>{o(3,I.scrollTop=I.scrollHeight,I)},Be=async(e,c=null)=>{if(console.log("submitPrompt",g),o(0,u=u.map(f=>G.map(m=>m.id).includes(f)?f:"")),u.includes(""))O.error("Model not selected");else if(r.length!=0&&r.at(-1).done!=!0)console.log("wait");else if(N.length>0&&N.filter(f=>f.upload_status===!1).length>0)O.error("Oops! Hold tight! Your files are still in the processing oven. We're cooking them up to perfection. Please be patient and we'll let you know once they're ready.");else{document.getElementById("chat-textarea").style.height="";let f=Ve(),m={id:f,parentId:r.length!==0?r.at(-1).id:null,childrenIds:[],role:"user",user:c??void 0,content:e,files:N.length>0?N:void 0,timestamp:Math.floor(Date.now()/1e3)};o(1,a.messages[f]=m,a),o(1,a.currentId=f,a),r.length!==0&&a.messages[r.at(-1).id].childrenIds.push(f),await Y(),r.length==1&&(t.saveChatHistory??!0?(B=await ut(localStorage.token,{id:g,title:"New Chat",models:u,system:t.system??void 0,options:{...t.options??{}},messages:r,history:a,tags:[],timestamp:Date.now()}),await ge.set(await me(localStorage.token)),await Oe.set(B.id)):await Oe.set("local"),await Y()),o(8,j=""),o(9,N=[]),await se(e,f)}},se=async(e,c)=>{const f=JSON.parse(JSON.stringify(g));await Promise.all(u.map(async m=>{const l=G.filter(_=>_.id===m).at(0);if(l){let _=Ve(),A={parentId:c,id:_,childrenIds:[],role:"assistant",content:"",model:l.id,timestamp:Math.floor(Date.now()/1e3)};o(1,a.messages[_]=A,a),o(1,a.currentId=_,a),c!==null&&o(1,a.messages[c].childrenIds=[...a.messages[c].childrenIds,_],a),l!=null&&l.external?await we(l,e,_,f):l&&await _e(l,e,_,f)}else O.error(`Model ${m} not found`)})),await ge.set(await me(localStorage.token))},_e=async(e,c,f,m)=>{var ue;e=e.id;const l=a.messages[f];await Y(),q();const _=[t.system?{role:"system",content:t.system}:void 0,...r].filter(d=>d).map((d,C,le)=>{var p;const D={role:d.role,content:le.length-2!==C?d.content:(d==null?void 0:d.raContent)??d.content},i=(p=d.files)==null?void 0:p.filter(L=>L.type==="image").map(L=>L.url.slice(L.url.indexOf(",")+1));return i&&i.length>0&&(D.images=i),D});let A=-1;_.forEach((d,C)=>{d.images&&(A=C)}),_.forEach((d,C)=>{C!==A&&delete d.images});const ie=r.filter(d=>(d==null?void 0:d.files)??null).map(d=>d.files.filter(C=>C.type==="doc"||C.type==="collection")).flat(1),[F,ce]=await it(localStorage.token,{model:e,messages:_,options:{...t.options??{}},format:t.requestFormat??void 0,keep_alive:t.keepAlive??void 0,docs:ie.length>0?ie:void 0});if(F&&F.ok){console.log("controller",ce);const d=F.body.pipeThrough(new TextDecoderStream).pipeThrough(We(`
`)).getReader();for(;;){const{value:C,done:le}=await d.read();if(le||H||m!==g){l.done=!0,o(10,r),o(1,a),H&&(ce.abort("User: Stop Response"),await Fe(localStorage.token,T)),T=null;break}try{let D=C.split(`
`);for(const i of D)if(i!==""){console.log(i);let p=JSON.parse(i);if("detail"in p)throw p;if("id"in p)console.log(p),T=p.id;else if(p.done==!1){if(l.content==""&&p.message.content==`
`)continue;l.content+=p.message.content,o(10,r),o(1,a)}else{if(l.done=!0,l.content==""&&(l.error=!0,l.content="Oops! No text generated from Ollama, Please try again."),l.context=p.context??null,l.info={total_duration:p.total_duration,load_duration:p.load_duration,sample_count:p.sample_count,sample_duration:p.sample_duration,prompt_eval_count:p.prompt_eval_count,prompt_eval_duration:p.prompt_eval_duration,eval_count:p.eval_count,eval_duration:p.eval_duration},o(10,r),o(1,a),t.notificationEnabled&&!document.hasFocus()){const L=new Notification(P?`${P.title.charAt(0).toUpperCase()+P.title.slice(1)}`:`${e}`,{body:l.content,icon:(P==null?void 0:P.imageUrl)??`${Je}/static/favicon.png`})}t.responseAutoCopy&&je(l.content),t.responseAutoPlayback&&(await Y(),(ue=document.getElementById(`speak-button-${l.id}`))==null||ue.click())}}}catch(D){console.log(D),"detail"in D&&O.error(D.detail);break}y&&q()}g==m&&(t.saveChatHistory??!0)&&(B=await he(localStorage.token,m,{messages:r,history:a}),await ge.set(await me(localStorage.token)))}else{if(F!==null){const d=await F.json();console.log(d),"detail"in d?(O.error(d.detail),l.content=d.detail):(O.error(d.error),l.content=d.error)}else O.error("Uh-oh! There was an issue connecting to Ollama."),l.content="Uh-oh! There was an issue connecting to Ollama.";l.error=!0,l.content="Uh-oh! There was an issue connecting to Ollama.",l.done=!0,o(10,r),o(1,a)}H=!1,await Y(),y&&q(),r.length==2&&r.at(1).content!==""&&(window.history.replaceState(a.state,"",`/c/${m}`),await ye(m,c))},we=async(e,c,f,m)=>{var ie,F,ce,ue,d,C,le,D;const l=a.messages[f];q();const _=r.filter(i=>(i==null?void 0:i.files)??null).map(i=>i.files.filter(p=>p.type==="doc"||p.type==="collection")).flat(1);console.log(_);const A=await gt(localStorage.token,{model:e.id,stream:!0,messages:[t.system?{role:"system",content:t.system}:void 0,...r].filter(i=>i).map((i,p,L)=>{var re;return{role:i.role,...((re=i.files)==null?void 0:re.filter(W=>W.type==="image").length)>0?{content:[{type:"text",text:L.length-1!==p?i.content:(i==null?void 0:i.raContent)??i.content},...i.files.filter(W=>W.type==="image").map(W=>({type:"image_url",image_url:{url:W.url}}))]}:{content:L.length-1!==p?i.content:(i==null?void 0:i.raContent)??i.content}}}),seed:((ie=t==null?void 0:t.options)==null?void 0:ie.seed)??void 0,stop:((F=t==null?void 0:t.options)==null?void 0:F.stop)??void 0,temperature:((ce=t==null?void 0:t.options)==null?void 0:ce.temperature)??void 0,top_p:((ue=t==null?void 0:t.options)==null?void 0:ue.top_p)??void 0,num_ctx:((d=t==null?void 0:t.options)==null?void 0:d.num_ctx)??void 0,frequency_penalty:((C=t==null?void 0:t.options)==null?void 0:C.repeat_penalty)??void 0,max_tokens:((le=t==null?void 0:t.options)==null?void 0:le.num_predict)??void 0,docs:_.length>0?_:void 0},e.source==="litellm"?`${ot}/v1`:`${st}`);if(A&&A.ok){const i=A.body.pipeThrough(new TextDecoderStream).pipeThrough(We(`
`)).getReader();for(;;){const{value:p,done:L}=await i.read();if(L||H||m!==g){l.done=!0,o(10,r),o(1,a);break}try{let re=p.split(`
`);for(const W of re)if(W!=="")if(W==="data: [DONE]")l.done=!0,o(10,r),o(1,a);else{let He=JSON.parse(W.replace(/^data: /,""));if(l.content==""&&He.choices[0].delta.content==`
`)continue;l.content+=He.choices[0].delta.content??"",o(10,r),o(1,a)}}catch(re){console.log(re)}t.notificationEnabled&&!document.hasFocus()&&new Notification(`OpenAI ${e}`,{body:l.content,icon:`${Je}/static/favicon.png`}),t.responseAutoCopy&&je(l.content),t.responseAutoPlayback&&(await Y(),(D=document.getElementById(`speak-button-${l.id}`))==null||D.click()),y&&q()}g==m&&(t.saveChatHistory??!0)&&(B=await he(localStorage.token,m,{messages:r,history:a}),await ge.set(await me(localStorage.token)))}else{if(A!==null){const i=await A.json();console.log(i),"detail"in i?(O.error(i.detail),l.content=i.detail):"message"in i.error?(O.error(i.error.message),l.content=i.error.message):(O.error(i.error),l.content=i.error)}else O.error(`Uh-oh! There was an issue connecting to ${e}.`),l.content=`Uh-oh! There was an issue connecting to ${e}.`;l.error=!0,l.content=`Uh-oh! There was an issue connecting to ${e}.`,l.done=!0,o(10,r),o(1,a)}H=!1,await Y(),y&&q(),r.length==2&&(window.history.replaceState(a.state,"",`/c/${m}`),t!=null&&t.titleAutoGenerateModel?await ye(m,c):await s(m,c))},Ue=()=>{H=!0,console.log("stopResponse")},ne=async()=>{if(console.log("regenerateResponse"),r.length!=0&&r.at(-1).done==!0){r.splice(r.length-1,1),o(10,r),o(1,a);let e=r.at(-1),c=e.content;await se(c,e.id)}},Re=async()=>{console.log("continueGeneration");const e=JSON.parse(JSON.stringify(g));if(r.length!=0&&r.at(-1).done==!0){const c=a.messages[a.currentId];c.done=!1,await Y();const f=G.filter(m=>m.id===c.model).at(0);f&&(f!=null&&f.external?await we(f,a.messages[c.parentId].content,c.id,e):await _e(f,a.messages[c.parentId].content,c.id,e))}else O.error(`Model ${modelId} not found`)},ye=async(e,c)=>{if(t.titleAutoGenerate??!0){const f=await ct(localStorage.token,(t==null?void 0:t.titleGenerationPrompt)??"Create a concise, 3-5 word phrase as a header for the following query, strictly adhering to the 3-5 word limit and avoiding the use of the word 'title': {{prompt}}",(t==null?void 0:t.titleAutoGenerateModel)??u[0],c);f&&await s(e,f)}else await s(e,`${c}`)},Se=async()=>await pt(localStorage.token,g).catch(async e=>[]),ae=async e=>{await ft(localStorage.token,g,e),o(6,J=await Se()),B=await he(localStorage.token,g,{tags:J}),qe.set(await ve(localStorage.token))},be=async e=>{await dt(localStorage.token,g,e),o(6,J=await Se()),B=await he(localStorage.token,g,{tags:J}),qe.set(await ve(localStorage.token))},s=async(e,c)=>{e===g&&o(7,b=c),(t.saveChatHistory??!0)&&(B=await he(localStorage.token,e,{title:c}),await ge.set(await me(localStorage.token)))};function h(e){u=e,o(0,u)}function U(e){a=e,o(1,a)}function V(e){r=e,o(10,r),o(1,a)}function k(e){y=e,o(2,y)}function R(e){z[e?"unshift":"push"](()=>{I=e,o(3,I)})}const Q=e=>{o(2,y=I.scrollHeight-I.scrollTop<=I.clientHeight+50)};function ke(e){N=e,o(9,N)}function Ye(e){j=e,o(8,j)}function ze(e){y=e,o(2,y)}return n.$$.update=()=>{if(n.$$.dirty[0]&8388609&&o(4,P=u.length===1&&M.filter(e=>e.tagName===u[0]).length>0?M.filter(e=>e.tagName===u[0])[0]:null),n.$$.dirty[0]&8388609&&o(5,te=u.reduce((e,c,f,m)=>{var _;const l=((_=M.filter(A=>A.tagName===c))==null?void 0:_.at(0))??void 0;return{...e,...l&&{[c]:l}}},{})),n.$$.dirty[0]&2)if(a.currentId!==null){let e=[],c=a.messages[a.currentId];for(;c!==null;)e.unshift({...c}),c=c.parentId!==null?a.messages[c.parentId]:null;o(10,r=e)}else o(10,r=[])},[u,a,y,I,P,te,J,b,j,N,r,t,g,w,E,oe,Be,se,Ue,ne,Re,ae,be,M,h,U,V,k,R,Q,ke,Ye,ze]}class Rt extends xe{constructor(K){super(),$e(this,K,bt,yt,Ke,{},null,[-1,-1])}}export{Rt as component};
