import{s as $e,a as ve,e as He,M as et,d as V,c as Pe,i as Re,w as X,o as tt,p as z,f as pe,g as de,h as ge,j as Z,r as x,u as ot,W as $,t as H}from"../chunks/scheduler.161605a7.js";import{S as st,i as nt,a as te,t as re,c as at,f as ee,b as Ie,d as Me,m as Te,e as Ce,g as lt}from"../chunks/index.acd0f037.js";import{g as rt}from"../chunks/globals.7f7f1b26.js";import{a as B}from"../chunks/Toaster.svelte_svelte_type_style_lang.51e71bae.js";import{g as Ee}from"../chunks/navigation.73b32ac1.js";import{p as it}from"../chunks/stores.861ae11e.js";import{e as me,g as Ne,a as Le,L as ct,O as ut,f as Je,s as Ge,m as ft,j as pt,W as dt,c as gt}from"../chunks/index.7deef04d.js";import{v as We,s as je,c as qe,d as mt}from"../chunks/index.496e36ff.js";import{e as ht,f as _t,h as Ve}from"../chunks/index.781620a4.js";import{c as wt,b as he,t as _e,y as yt,x as Fe,z as bt,A as St,r as kt}from"../chunks/index.9f4636fe.js";import{d as It}from"../chunks/index.1d44562a.js";import{N as Mt,M as Tt,a as Ct,b as Et}from"../chunks/Navbar.dd013095.js";const{document:Ue}=rt;function ze(o){var be;let S,t,s,p,u,f,_,oe,Y,se,T,w,C,U,k,v,I,M,L,K,J,P,r;t=new Mt({props:{title:o[9],shareEnabled:o[12].length>0,initNewChat:o[26],tags:o[8],addTag:o[22],deleteTag:o[23]}});function a(n){o[27](n)}let we={};o[0]!==void 0&&(we.selectedModels=o[0]),_=new Tt({props:we}),z.push(()=>ee(_,"selectedModels",a));function W(n){o[28](n)}function Ae(n){o[29](n)}function ie(n){o[30](n)}let Q={chatId:o[14],selectedModels:o[0],selectedModelfiles:o[7],processing:vt,bottomPadding:o[11].length>0,sendPrompt:o[18],continueGeneration:o[20],regenerateResponse:o[21]};o[1]!==void 0&&(Q.history=o[1]),o[12]!==void 0&&(Q.messages=o[12]),o[3]!==void 0&&(Q.autoScroll=o[3]),w=new Ct({props:Q}),z.push(()=>ee(w,"history",W)),z.push(()=>ee(w,"messages",Ae)),z.push(()=>ee(w,"autoScroll",ie));function ye(n){o[33](n)}function Oe(n){o[34](n)}function Be(n){o[35](n)}let ne={suggestionPrompts:((be=o[6])==null?void 0:be.suggestionPrompts)??o[16].default_prompt_suggestions,messages:o[12],submitPrompt:o[17],stopResponse:o[19]};return o[11]!==void 0&&(ne.files=o[11]),o[10]!==void 0&&(ne.prompt=o[10]),o[3]!==void 0&&(ne.autoScroll=o[3]),I=new Et({props:ne}),z.push(()=>ee(I,"files",ye)),z.push(()=>ee(I,"prompt",Oe)),z.push(()=>ee(I,"autoScroll",Be)),{c(){S=pe("div"),Ie(t.$$.fragment),s=ve(),p=pe("div"),u=pe("div"),f=pe("div"),Ie(_.$$.fragment),se=ve(),T=pe("div"),Ie(w.$$.fragment),v=ve(),Ie(I.$$.fragment),this.h()},l(n){S=de(n,"DIV",{class:!0});var g=ge(S);Me(t.$$.fragment,g),s=Pe(g),p=de(g,"DIV",{class:!0});var A=ge(p);u=de(A,"DIV",{class:!0,id:!0});var j=ge(u);f=de(j,"DIV",{class:!0});var E=ge(f);Me(_.$$.fragment,E),E.forEach(V),se=Pe(j),T=de(j,"DIV",{class:!0});var R=ge(T);Me(w.$$.fragment,R),R.forEach(V),j.forEach(V),v=Pe(A),Me(I.$$.fragment,A),A.forEach(V),g.forEach(V),this.h()},h(){var n;Z(f,"class",Y=(((n=o[13])==null?void 0:n.fullScreenMode)??null?"max-w-full":"max-w-2xl md:px-0")+" mx-auto w-full px-4"),Z(T,"class","h-full w-full flex flex-col py-8"),Z(u,"class","pb-2.5 flex flex-col justify-between w-full flex-auto overflow-auto h-0"),Z(u,"id","messages-container"),Z(p,"class","flex flex-col flex-auto"),Z(S,"class","min-h-screen max-h-screen w-full flex flex-col")},m(n,g){Re(n,S,g),Te(t,S,null),x(S,s),x(S,p),x(p,u),x(u,f),Te(_,f,null),x(u,se),x(u,T),Te(w,T,null),o[31](u),x(p,v),Te(I,p,null),J=!0,P||(r=ot(u,"scroll",o[32]),P=!0)},p(n,g){var Se,ke;const A={};g[0]&512&&(A.title=n[9]),g[0]&4096&&(A.shareEnabled=n[12].length>0),g[0]&32&&(A.initNewChat=n[26]),g[0]&256&&(A.tags=n[8]),t.$set(A);const j={};!oe&&g[0]&1&&(oe=!0,j.selectedModels=n[0],$(()=>oe=!1)),_.$set(j),(!J||g[0]&8192&&Y!==(Y=(((Se=n[13])==null?void 0:Se.fullScreenMode)??null?"max-w-full":"max-w-2xl md:px-0")+" mx-auto w-full px-4"))&&Z(f,"class",Y);const E={};g[0]&16384&&(E.chatId=n[14]),g[0]&1&&(E.selectedModels=n[0]),g[0]&128&&(E.selectedModelfiles=n[7]),g[0]&2048&&(E.bottomPadding=n[11].length>0),!C&&g[0]&2&&(C=!0,E.history=n[1],$(()=>C=!1)),!U&&g[0]&4096&&(U=!0,E.messages=n[12],$(()=>U=!1)),!k&&g[0]&8&&(k=!0,E.autoScroll=n[3],$(()=>k=!1)),w.$set(E);const R={};g[0]&65600&&(R.suggestionPrompts=((ke=n[6])==null?void 0:ke.suggestionPrompts)??n[16].default_prompt_suggestions),g[0]&4096&&(R.messages=n[12]),!M&&g[0]&2048&&(M=!0,R.files=n[11],$(()=>M=!1)),!L&&g[0]&1024&&(L=!0,R.prompt=n[10],$(()=>L=!1)),!K&&g[0]&8&&(K=!0,R.autoScroll=n[3],$(()=>K=!1)),I.$set(R)},i(n){J||(te(t.$$.fragment,n),te(_.$$.fragment,n),te(w.$$.fragment,n),te(I.$$.fragment,n),J=!0)},o(n){re(t.$$.fragment,n),re(_.$$.fragment,n),re(w.$$.fragment,n),re(I.$$.fragment,n),J=!1},d(n){n&&V(S),Ce(t),Ce(_),Ce(w),o[31](null),Ce(I),P=!1,r()}}}function Nt(o){let S,t,s,p;Ue.title=S=`
		`+(o[9]?`${o[9].length>30?`${o[9].slice(0,30)}...`:o[9]} | ${o[15]}`:`${o[15]}`)+`
	`;let u=o[2]&&ze(o);return{c(){t=ve(),u&&u.c(),s=He()},l(f){et("svelte-1123lr8",Ue.head).forEach(V),t=Pe(f),u&&u.l(f),s=He()},m(f,_){Re(f,t,_),u&&u.m(f,_),Re(f,s,_),p=!0},p(f,_){(!p||_[0]&33280)&&S!==(S=`
		`+(f[9]?`${f[9].length>30?`${f[9].slice(0,30)}...`:f[9]} | ${f[15]}`:`${f[15]}`)+`
	`)&&(Ue.title=S),f[2]?u?(u.p(f,_),_[0]&4&&te(u,1)):(u=ze(f),u.c(),te(u,1),u.m(s.parentNode,s)):u&&(lt(),re(u,1,1,()=>{u=null}),at())},i(f){p||(te(u),p=!0)},o(f){re(u),p=!1},d(f){f&&(V(t),V(s)),u&&u.d(f)}}}let vt="";function Pt(o,S,t){let s,p,u,f,_,oe,Y;X(o,Ge,e=>t(13,s=e)),X(o,Ne,e=>t(14,p=e)),X(o,ft,e=>t(38,u=e)),X(o,it,e=>t(24,f=e)),X(o,pt,e=>t(25,_=e)),X(o,dt,e=>t(15,oe=e)),X(o,gt,e=>t(16,Y=e));let se=!1,T=!1,w=!0,C,U=null,k=[""],v=null,I={},M=null,L=[],K="",J="",P=[],r=[],a={messages:{},currentId:null};const we=async()=>{if(await Ne.set(f.params.id),M=await kt(localStorage.token,p).catch(async e=>(await Ee("/"),null)),M){t(8,L=await g());const e=M.chat;if(e){console.log(e),t(0,k=((e==null?void 0:e.models)??void 0)!==void 0?e.models:[e.models??""]),t(1,a=((e==null?void 0:e.history)??void 0)!==void 0?e.history:mt(e.messages)),t(9,K=e.title);let c=JSON.parse(localStorage.getItem("settings")??"{}");return await Ge.set({...c,system:e.system??c.system,options:e.options??c.options}),t(3,w=!0),await H(),r.length>0&&t(1,a.messages[r.at(-1).id].done=!0,a),await H(),!0}else return null}},W=()=>{t(4,C.scrollTop=C.scrollHeight,C)},Ae=async(e,c=null)=>{if(console.log("submitPrompt",p),k.includes(""))B.error("Model not selected");else if(r.length!=0&&r.at(-1).done!=!0)console.log("wait");else if(P.length>0&&P.filter(h=>h.upload_status===!1).length>0)B.error("Oops! Hold tight! Your files are still in the processing oven. We're cooking them up to perfection. Please be patient and we'll let you know once they're ready.");else{document.getElementById("chat-textarea").style.height="";let h=We(),y={id:h,parentId:r.length!==0?r.at(-1).id:null,childrenIds:[],role:"user",user:c??void 0,content:e,files:P.length>0?P:void 0,timestamp:Math.floor(Date.now()/1e3)};t(1,a.messages[h]=y,a),t(1,a.currentId=h,a),r.length!==0&&a.messages[r.at(-1).id].childrenIds.push(h),await H(),r.length==1&&(s.saveChatHistory??!0?(M=await wt(localStorage.token,{id:p,title:"New Chat",models:k,system:s.system??void 0,options:{...s.options??{}},messages:r,history:a,timestamp:Date.now()}),await me.set(await he(localStorage.token)),await Ne.set(M.id)):await Ne.set("local"),await H()),t(10,J=""),t(11,P=[]),await ie(e,h)}},ie=async(e,c)=>{const h=JSON.parse(JSON.stringify(p));await Promise.all(k.map(async y=>{const l=u.filter(b=>b.id===y).at(0);if(l){let b=We(),O={parentId:c,id:b,childrenIds:[],role:"assistant",content:"",model:l.id,timestamp:Math.floor(Date.now()/1e3)};t(1,a.messages[b]=O,a),t(1,a.currentId=b,a),c!==null&&t(1,a.messages[c].childrenIds=[...a.messages[c].childrenIds,b],a),l!=null&&l.external?await ye(l,e,b,h):l&&await Q(l,e,b,h)}else B.error(`Model ${y} not found`)})),await me.set(await he(localStorage.token))},Q=async(e,c,h,y)=>{var fe;e=e.id;const l=a.messages[h];await H(),W();const b=[s.system?{role:"system",content:s.system}:void 0,...r].filter(d=>d).map((d,N,ae)=>{var m;const D={role:d.role,content:ae.length-2!==N?d.content:(d==null?void 0:d.raContent)??d.content},i=(m=d.files)==null?void 0:m.filter(G=>G.type==="image").map(G=>G.url.slice(G.url.indexOf(",")+1));return i&&i.length>0&&(D.images=i),D});let O=-1;b.forEach((d,N)=>{d.images&&(O=N)}),b.forEach((d,N)=>{N!==O&&delete d.images});const ce=r.filter(d=>(d==null?void 0:d.files)??null).map(d=>d.files.filter(N=>N.type==="doc"||N.type==="collection")).flat(1),[F,ue]=await ht(localStorage.token,{model:e,messages:b,options:{...s.options??{}},format:s.requestFormat??void 0,keep_alive:s.keepAlive??void 0,docs:ce.length>0?ce:void 0});if(F&&F.ok){console.log("controller",ue);const d=F.body.pipeThrough(new TextDecoderStream).pipeThrough(je(`
`)).getReader();for(;;){const{value:N,done:ae}=await d.read();if(ae||T||y!==p){l.done=!0,t(12,r),t(1,a),T&&(ue.abort("User: Stop Response"),await Ve(localStorage.token,U)),t(5,U=null);break}try{let D=N.split(`
`);for(const i of D)if(i!==""){let m=JSON.parse(i);if("detail"in m)throw m;if("id"in m)t(5,U=m.id);else if(m.done==!1){if(l.content==""&&m.message.content==`
`)continue;l.content+=m.message.content,t(12,r),t(1,a)}else{if(l.done=!0,l.content==""&&(l.error=!0,l.content="Oops! No text generated from Ollama, Please try again."),l.context=m.context??null,l.info={total_duration:m.total_duration,load_duration:m.load_duration,sample_count:m.sample_count,sample_duration:m.sample_duration,prompt_eval_count:m.prompt_eval_count,prompt_eval_duration:m.prompt_eval_duration,eval_count:m.eval_count,eval_duration:m.eval_duration},t(12,r),t(1,a),s.notificationEnabled&&!document.hasFocus()){const G=new Notification(v?`${v.title.charAt(0).toUpperCase()+v.title.slice(1)}`:`${e}`,{body:l.content,icon:(v==null?void 0:v.imageUrl)??`${Le}/static/favicon.png`})}s.responseAutoCopy&&qe(l.content),s.responseAutoPlayback&&(await H(),(fe=document.getElementById(`speak-button-${l.id}`))==null||fe.click())}}}catch(D){console.log(D),"detail"in D&&B.error(D.detail);break}W()}p==y&&(s.saveChatHistory??!0)&&(M=await _e(localStorage.token,y,{messages:r,history:a}),await me.set(await he(localStorage.token)))}else{if(F!==null){const d=await F.json();console.log(d),"detail"in d?(B.error(d.detail),l.content=d.detail):(B.error(d.error),l.content=d.error)}else B.error("Uh-oh! There was an issue connecting to Ollama."),l.content="Uh-oh! There was an issue connecting to Ollama.";l.error=!0,l.content="Uh-oh! There was an issue connecting to Ollama.",l.done=!0,t(12,r),t(1,a)}T=!1,await H(),W(),r.length==2&&r.at(1).content!==""&&(window.history.replaceState(a.state,"",`/c/${y}`),await be(y,c))},ye=async(e,c,h,y)=>{var ce,F,ue,fe,d,N,ae,D;const l=a.messages[h];W();const b=r.filter(i=>(i==null?void 0:i.files)??null).map(i=>i.files.filter(m=>m.type==="doc"||m.type==="collection")).flat(1);console.log(b);const O=await It(localStorage.token,{model:e.id,stream:!0,messages:[s.system?{role:"system",content:s.system}:void 0,...r].filter(i=>i).map((i,m,G)=>{var le;return{role:i.role,...((le=i.files)==null?void 0:le.filter(q=>q.type==="image").length)>0?{content:[{type:"text",text:G.length-1!==m?i.content:(i==null?void 0:i.raContent)??i.content},...i.files.filter(q=>q.type==="image").map(q=>({type:"image_url",image_url:{url:q.url}}))]}:{content:G.length-1!==m?i.content:(i==null?void 0:i.raContent)??i.content}}}),seed:((ce=s==null?void 0:s.options)==null?void 0:ce.seed)??void 0,stop:((F=s==null?void 0:s.options)==null?void 0:F.stop)??void 0,temperature:((ue=s==null?void 0:s.options)==null?void 0:ue.temperature)??void 0,top_p:((fe=s==null?void 0:s.options)==null?void 0:fe.top_p)??void 0,num_ctx:((d=s==null?void 0:s.options)==null?void 0:d.num_ctx)??void 0,frequency_penalty:((N=s==null?void 0:s.options)==null?void 0:N.repeat_penalty)??void 0,max_tokens:((ae=s==null?void 0:s.options)==null?void 0:ae.num_predict)??void 0,docs:b.length>0?b:void 0},e.source==="litellm"?`${ct}/v1`:`${ut}`);if(O&&O.ok){const i=O.body.pipeThrough(new TextDecoderStream).pipeThrough(je(`
`)).getReader();for(;;){const{value:m,done:G}=await i.read();if(G||T||y!==p){l.done=!0,t(12,r),t(1,a);break}try{let le=m.split(`
`);for(const q of le)if(q!=="")if(q==="data: [DONE]")l.done=!0,t(12,r),t(1,a);else{let De=JSON.parse(q.replace(/^data: /,""));if(l.content==""&&De.choices[0].delta.content==`
`)continue;l.content+=De.choices[0].delta.content??"",t(12,r),t(1,a)}}catch(le){console.log(le)}s.notificationEnabled&&!document.hasFocus()&&new Notification(`OpenAI ${e}`,{body:l.content,icon:`${Le}/static/favicon.png`}),s.responseAutoCopy&&qe(l.content),s.responseAutoPlayback&&(await H(),(D=document.getElementById(`speak-button-${l.id}`))==null||D.click()),W()}p==y&&(s.saveChatHistory??!0)&&(M=await _e(localStorage.token,y,{messages:r,history:a}),await me.set(await he(localStorage.token)))}else{if(O!==null){const i=await O.json();console.log(i),"detail"in i?(B.error(i.detail),l.content=i.detail):"message"in i.error?(B.error(i.error.message),l.content=i.error.message):(B.error(i.error),l.content=i.error)}else B.error(`Uh-oh! There was an issue connecting to ${e}.`),l.content=`Uh-oh! There was an issue connecting to ${e}.`;l.error=!0,l.content=`Uh-oh! There was an issue connecting to ${e}.`,l.done=!0,t(12,r),t(1,a)}T=!1,await H(),W(),r.length==2&&(window.history.replaceState(a.state,"",`/c/${y}`),await n(y,c))},Oe=()=>{T=!0,console.log("stopResponse")},Be=async()=>{console.log("continueGeneration");const e=JSON.parse(JSON.stringify(p));if(r.length!=0&&r.at(-1).done==!0){const c=a.messages[a.currentId];c.done=!1,await H();const h=u.filter(y=>y.id===c.model).at(0);h&&(h!=null&&h.external?await ye(h,a.messages[c.parentId].content,c.id,e):await Q(h,a.messages[c.parentId].content,c.id,e))}else B.error(`Model ${modelId} not found`)},ne=async()=>{if(console.log("regenerateResponse"),r.length!=0&&r.at(-1).done==!0){r.splice(r.length-1,1),t(12,r),t(1,a);let e=r.at(-1),c=e.content;await ie(c,e.id)}},be=async(e,c)=>{if(s.titleAutoGenerate??!0){const h=await _t(localStorage.token,(s==null?void 0:s.titleGenerationPrompt)??"Create a concise, 3-5 word phrase as a header for the following query, strictly adhering to the 3-5 word limit and avoiding the use of the word 'title': {{prompt}}",(s==null?void 0:s.titleAutoGenerateModel)??k[0],c);h&&await n(e,h)}else await n(e,`${c}`)},n=async(e,c)=>{e===p&&t(9,K=c),M=await _e(localStorage.token,e,{title:c}),await me.set(await he(localStorage.token))},g=async()=>await St(localStorage.token,p).catch(async e=>[]),A=async e=>{await yt(localStorage.token,p,e),t(8,L=await g()),M=await _e(localStorage.token,p,{tags:L}),Je.set(await Fe(localStorage.token))},j=async e=>{await bt(localStorage.token,p,e),t(8,L=await g()),M=await _e(localStorage.token,p,{tags:L}),Je.set(await Fe(localStorage.token))};tt(async()=>{(s.saveChatHistory??!0)||await Ee("/")});const E=async()=>{U!==null&&(await Ve(localStorage.token,U),t(5,U=null)),Ee("/")};function R(e){k=e,t(0,k)}function Se(e){a=e,t(1,a)}function ke(e){r=e,t(12,r),t(1,a)}function Ye(e){w=e,t(3,w)}function Ke(e){z[e?"unshift":"push"](()=>{C=e,t(4,C)})}const Qe=e=>{t(3,w=C.scrollHeight-C.scrollTop<=C.clientHeight+50)};function Xe(e){P=e,t(11,P)}function Ze(e){J=e,t(10,J)}function xe(e){w=e,t(3,w)}return o.$$.update=()=>{if(o.$$.dirty[0]&33554433&&t(6,v=k.length===1&&_.filter(e=>e.tagName===k[0]).length>0?_.filter(e=>e.tagName===k[0])[0]:null),o.$$.dirty[0]&33554433&&t(7,I=k.reduce((e,c,h,y)=>{var b;const l=((b=_.filter(O=>O.tagName===c))==null?void 0:b.at(0))??void 0;return{...e,...l&&{[c]:l}}},{})),o.$$.dirty[0]&2)if(a.currentId!==null){let e=[],c=a.messages[a.currentId];for(;c!==null;)e.unshift({...c}),c=c.parentId!==null?a.messages[c.parentId]:null;t(12,r=e)}else t(12,r=[]);o.$$.dirty[0]&16777216&&f.params.id&&(async()=>{if(await we()){await H(),t(2,se=!0),window.setTimeout(()=>W(),0);const e=document.getElementById("chat-textarea");e==null||e.focus()}else await Ee("/")})()},[k,a,se,w,C,U,v,I,L,K,J,P,r,s,p,oe,Y,Ae,ie,Oe,Be,ne,A,j,f,_,E,R,Se,ke,Ye,Ke,Qe,Xe,Ze,xe]}class qt extends st{constructor(S){super(),nt(this,S,Pt,Nt,$e,{},null,[-1,-1])}}export{qt as component};
